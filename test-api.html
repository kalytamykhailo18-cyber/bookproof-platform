<!DOCTYPE html>
<html>
<head>
    <title>API Test</title>
</head>
<body>
    <h1>BookProof API Test</h1>
    <button onclick="testHealth()">Test Health</button>
    <button onclick="testLogin()">Test Login</button>
    <button onclick="testAdminReaders()">Test Admin Readers</button>
    <button onclick="checkToken()">Check Token</button>
    <button onclick="clearToken()">Clear Token</button>
    <pre id="result"></pre>

    <script>
        const API_URL = 'http://localhost:4000/api/v1';
        const output = document.getElementById('result');

        function log(msg) {
            output.textContent += msg + '\n';
            console.log(msg);
        }

        function checkToken() {
            output.textContent = '';
            const token = localStorage.getItem('bookproof_token');
            log('Token in localStorage: ' + (token ? token.substring(0, 50) + '...' : 'NOT FOUND'));

            const authStorage = localStorage.getItem('bookproof-auth');
            log('Auth state: ' + (authStorage ? authStorage.substring(0, 100) + '...' : 'NOT FOUND'));
        }

        function clearToken() {
            localStorage.removeItem('bookproof_token');
            localStorage.removeItem('bookproof-auth');
            log('Token cleared!');
        }

        async function testHealth() {
            output.textContent = '';
            try {
                const response = await fetch(`${API_URL}/health`);
                log('Health Status: ' + response.status);
                const data = await response.json();
                log('Health Response: ' + JSON.stringify(data, null, 2));
            } catch (error) {
                log('Health Error: ' + error.message);
            }
        }

        async function testLogin() {
            output.textContent = '';
            try {
                log('Attempting login...');
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'superadmin@bookproof.app',
                        password: 'password123'
                    })
                });

                log('Login Status: ' + response.status);

                if (response.ok) {
                    const data = await response.json();
                    log('Login Success!');
                    log('User: ' + data.user.email);
                    log('Token: ' + data.accessToken.substring(0, 50) + '...');

                    // Save token
                    localStorage.setItem('bookproof_token', data.accessToken);
                    log('Token saved to localStorage');
                } else {
                    const error = await response.json();
                    log('Login Failed: ' + JSON.stringify(error));
                }
            } catch (error) {
                log('Login Error: ' + error.message);
            }
        }

        async function testAdminReaders() {
            output.textContent = '';
            const token = localStorage.getItem('bookproof_token');

            if (!token) {
                log('ERROR: No token found. Please login first.');
                return;
            }

            try {
                log('Fetching admin readers...');
                log('Using token: ' + token.substring(0, 50) + '...');

                const response = await fetch(`${API_URL}/admin/readers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                log('Status: ' + response.status);

                if (response.ok) {
                    const data = await response.json();
                    log('Success! Got ' + data.readers.length + ' readers');
                    log('Response: ' + JSON.stringify(data, null, 2));
                } else {
                    const error = await response.json();
                    log('Error: ' + JSON.stringify(error, null, 2));
                }
            } catch (error) {
                log('Network Error: ' + error.message);
            }
        }

        // Auto-check token on load
        window.onload = checkToken;
    </script>
</body>
</html>
